name: Cypress Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  api-tests:
    name: ğŸ”Œ API Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: â–¶ï¸ Rodar testes de API
        run: npx cypress run --spec "cypress/e2e/api/**/*.cy.{js,ts}"

      - name: ğŸ“„ Publicar artefatos dos testes de API
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-api-artifacts
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 30

  e2e-tests:
    name: ğŸ§ª E2E Tests (Cucumber)
    runs-on: ubuntu-latest
    needs: api-tests
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ğŸ› ï¸ Instalar dependÃªncias do sistema (resiliente)
        run: |
          set -eo pipefail
          echo "Updating apt cache..."
          sudo apt-get update -y

          # Packages commonly required by Cypress; we check each one and only attempt to install if apt has a candidate.
          PACKAGES=(libgtk2.0-0 libgtk-3-0 libgbm1 libnotify4 libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb)

          for pkg in "${PACKAGES[@]}"; do
            echo "----"
            echo "Checking availability for package: $pkg"
            # apt-cache policy prints "Candidate: (none)" when no candidate is available
            if apt-cache policy "$pkg" 2>/dev/null | grep -q "Candidate:"; then
              if apt-cache policy "$pkg" 2>/dev/null | grep -q "Candidate: (none)"; then
                echo "Package $pkg has no candidate in apt repos on this runner â€” skipping."
              else
                echo "Package $pkg has candidate â€” installing (no-install-recommends)."
                # install each package individually so failures for one don't abort the loop
                sudo apt-get install -y --no-install-recommends "$pkg" || {
                  echo "Install of $pkg failed; skipping and continuing."
                }
              fi
            else
              echo "apt-cache did not return Candidate information for $pkg â€” skipping."
            fi
          done

          echo "System package install step complete."

      - name: âœ… Verificar instalaÃ§Ã£o do Cypress
        run: npx cypress verify

      - name: â–¶ï¸ Rodar testes E2E (Cucumber .feature)
        # Use xvfb-run to avoid display issues in headless CI environments and
        # run only feature files under cypress/e2e for clarity.
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" npx cypress run --spec "cypress/e2e/**/*.feature"

      - name: ğŸ§© Criar pasta de evidÃªncias
        if: always()
        run: mkdir -p cypress/screenshots

      - name: ğŸ“„ Publicar artefatos dos testes E2E
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-e2e-artifacts
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 30

      - name: ğŸ§± Gerar Allure Report (resiliente)
        if: always()
        run: |
          if [ -d allure-results ] && [ "$(ls -A allure-results)" ]; then
            npx allure generate allure-results --clean -o allure-report
          else
            echo "No allure-results found; creating placeholder report so subsequent steps won't fail."
            mkdir -p allure-report
            cat > allure-report/index.html <<'HTML'
            <!doctype html>
            <html>
              <head><meta charset="utf-8"><title>No Allure Results</title></head>
              <body><h1>No Allure Results</h1><p>There were no allure-results produced in this run.</p></body>
            </html>
            HTML
          fi

      - name: ğŸ“¦ Compactar relatÃ³rio Allure
        if: always()
        run: |
          if [ -d "allure-report" ]; then
            zip -r allure-report.zip allure-report
          else
            echo "No allure-report directory to zip; creating empty zip placeholder."
            mkdir -p tmp-empty-report && zip -r allure-report.zip tmp-empty-report && rm -rf tmp-empty-report
          fi

      - name: ğŸ“¤ Upload do Allure Report ZIP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-zip
          path: allure-report.zip
          retention-days: 30

      - name: ğŸŒ Publicar Allure Report no GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          publish_branch: gh-pages
          force_orphan: true

      - name: ğŸ“¢ Mostrar URL do Report
        if: always()
        run: |
          owner="${{ github.repository_owner }}"
          repo="${{ github.event.repository.name }}"
          echo "âœ… Allure Report publicado!"
          echo "ğŸ”— Acesse em: https://${owner}.github.io/${repo}/"
